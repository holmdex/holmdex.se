name: Biannual Market Patterns Report

on:
  schedule:
    - cron: '0 0 1 1,7 *'  # Run on January 1st and July 1st
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Explicitly grant write permission to repository contents

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    env:
      R_LIBS_USER: ${{ github.workspace }}/r-libs
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      TZ: UTC
      R_CHECK_SYSTEM_CLOCK_: FALSE
      NOT_CRAN: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Clean previous reports
        run: rm -f weekday-market-patterns.html market-patterns-report-*.html global_market_data_cache_*.rds
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true
      
      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.3.450
      
      - name: Get Date
        id: get-date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libfreetype6-dev \
            libharfbuzz-dev libfribidi-dev \
            libudunits2-dev libgdal-dev libgeos-dev libproj-dev \
            pkg-config
      
      - name: Setup R package directories
        run: mkdir -p ${{ env.R_LIBS_USER }}
      
      - name: Cache R packages
        uses: actions/cache@v3
        id: r-pkg-cache
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-pkg-${{ hashFiles('weekday-market-patterns.qmd') }}-${{ steps.get-date.outputs.date }}
          restore-keys: |
            ${{ runner.os }}-r-pkg-${{ hashFiles('weekday-market-patterns.qmd') }}-
            ${{ runner.os }}-r-pkg-
      
      - name: Install core R packages
        run: |
          # Install tidyverse first
          Rscript -e 'install.packages("tidyverse", repos = "https://cloud.r-project.org")'
          
          # Install explicitly defined essential packages
          Rscript -e 'install.packages(c(
            "lubridate", 
            "plotly", 
            "knitr", 
            "rmarkdown", 
            "jsonlite", 
            "httr", 
            "rvest", 
            "xml2", 
            "curl", 
            "DT", 
            "quantmod", 
            "TTR", 
            "tidyquant", 
            "htmlwidgets", 
            "htmltools", 
            "scales"
          ), repos = "https://cloud.r-project.org")'
      
      - name: Create .Rprofile for namespace handling
        run: |
          cat > .Rprofile << 'EOF'
          # Suppress startup messages
          options(tidyverse.quiet = TRUE)
          
          # Set explicit function preferences to avoid namespace conflicts
          assign("filter", dplyr::filter, envir = .GlobalEnv)
          assign("select", dplyr::select, envir = .GlobalEnv)
          assign("group_by", dplyr::group_by, envir = .GlobalEnv)
          assign("summarize", dplyr::summarize, envir = .GlobalEnv)
          assign("mutate", dplyr::mutate, envir = .GlobalEnv)
          assign("arrange", dplyr::arrange, envir = .GlobalEnv)
          
          # Set additional options
          options(
            width = 120,
            scipen = 999,
            max.print = 1000,
            warn = 1,
            repos = c(CRAN = "https://cloud.r-project.org")
          )
          EOF
      
      - name: Render market patterns report
        run: |
          # Set environment variables for R
          export R_MAX_VSIZE=16Gb
          export R_MAX_NUM_THREADS=4
          
          # Set Quarto options
          QUARTO_RENDER_ARGS="--execute-timeout=1200"
          
          # Run with a timeout
          timeout 30m quarto render weekday-market-patterns.qmd --to html $QUARTO_RENDER_ARGS || (echo "Quarto render had issues, checking for output...")
          
          # Check if the output was generated despite errors
          if [ -f weekday-market-patterns.html ]; then
            echo "Successfully generated weekday-market-patterns.html"
          else
            echo "ERROR: Failed to generate weekday-market-patterns.html"
            exit 1
          fi
      
      - name: Create dated report copy
        run: |
          if [ -f weekday-market-patterns.html ]; then
            cp weekday-market-patterns.html "market-patterns-report-$(date +'%Y-%m-%d').html"
            echo "Created dated copy of the report"
          else
            echo "ERROR: Could not create dated copy - source file not found"
            exit 1
          fi
      
      - name: Optimize HTML file
        run: |
          if [ -f weekday-market-patterns.html ]; then
            sudo npm install -g html-minifier
            
            html-minifier --collapse-whitespace --remove-comments --remove-optional-tags \
              --remove-redundant-attributes --remove-script-type-attributes \
              --remove-tag-whitespace --use-short-doctype \
              weekday-market-patterns.html -o weekday-market-patterns.min.html || echo "Minification failed, using original file"
            
            if [ -f weekday-market-patterns.min.html ] && [ -s weekday-market-patterns.min.html ]; then
              mv weekday-market-patterns.min.html weekday-market-patterns.html
              echo "Successfully minified HTML file"
            else
              echo "Warning: Could not minify HTML file, using original"
            fi
          fi
      
      - name: Deploy report files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update market patterns report [automated] ${{ steps.get-date.outputs.date }}"
          file_pattern: "weekday-market-patterns.html market-patterns-report-*.html"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
          commit_author: GitHub Actions <actions@github.com>
          push_options: '--force'
          skip_dirty_check: true
