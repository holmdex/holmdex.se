name: Biannual Market Patterns Report

on:
  schedule:
    - cron: '0 0 1 1,7 *'  # Run on January 1st and July 1st
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Explicitly grant write permission to repository contents

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    env:
      R_LIBS_USER: ${{ github.workspace }}/r-libs
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      TZ: UTC
      R_CHECK_SYSTEM_CLOCK_: FALSE
      NOT_CRAN: true
      # Increase memory limits for R
      R_MAX_VSIZE: 32Gb
      R_MAX_NUM_THREADS: 4
      # Prevent R from stopping on warnings
      R_KEEP_PKG_SOURCE: yes
      # Set a longer timeout for downloads
      DOWNLOAD_TIMEOUT: 600
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # Using v4 for better performance
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Create data directory
        run: |
          # Create data directory if it doesn't exist
          mkdir -p data
          # Create timestamp variables for cache keys
          echo "CACHE_DATE=$(date +'%Y_%m_%d')" >> $GITHUB_ENV
          echo "CACHE_WEEK=$(date +'%Y_%W')" >> $GITHUB_ENV
          echo "CACHE_MONTH=$(date +'%Y_%m')" >> $GITHUB_ENV
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true
      
      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.3.450
      
      - name: Get Date
        id: get-date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libfreetype6-dev \
            libharfbuzz-dev libfribidi-dev \
            libudunits2-dev libgdal-dev libgeos-dev libproj-dev \
            pkg-config libv8-dev libsodium-dev
          
          # Install Chrome dependencies for plotly HTML export
          sudo apt-get install -y --no-install-recommends \
            libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 libcups2 \
            libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 \
            libxrandr2 libgbm1 libpulse0 libasound2
      
      - name: Setup R package directories
        run: mkdir -p ${{ env.R_LIBS_USER }}
      
      - name: Cache R packages
        uses: actions/cache@v3
        id: r-pkg-cache
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-pkg-${{ hashFiles('weekday-market-patterns.qmd') }}-${{ steps.get-date.outputs.date }}
          restore-keys: |
            ${{ runner.os }}-r-pkg-${{ hashFiles('weekday-market-patterns.qmd') }}-
            ${{ runner.os }}-r-pkg-
      
      - name: Cache market data
        uses: actions/cache@v3
        id: market-data-cache
        with:
          path: data/
          key: market-data-${{ env.CACHE_WEEK }}
          restore-keys: |
            market-data-${{ env.CACHE_MONTH }}
            market-data-
      
      - name: Install core R packages
        run: |
          # Install basic packages needed for package installation
          Rscript -e 'install.packages(c("remotes", "pak"), repos = "https://cloud.r-project.org")'
          
          # Set repository mirror with binary packages
          Rscript -e 'options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/noble/latest"))'
          
          # Install tidyverse with proper error handling
          Rscript -e '
          tryCatch({
            install.packages("tidyverse")
            cat("Successfully installed tidyverse\n")
          }, error = function(e) {
            cat("Error installing tidyverse:", e$message, "\n")
            cat("Trying individual tidyverse components instead\n")
            # Try installing individual components
            install.packages(c("ggplot2", "dplyr", "tidyr", "readr", "purrr", "tibble", "stringr", "forcats"))
          })'
      
      - name: Install additional packages
        run: |
          # Install plotting and other essential packages
          Rscript -e '
          packages <- c(
            "lubridate", "plotly", "knitr", "rmarkdown", "jsonlite", 
            "httr", "rvest", "xml2", "curl", "DT", "quantmod", 
            "tidyquant", "htmlwidgets", "htmltools", "scales", "RCurl"
          )
          
          # Install each package separately to avoid dependency issues
          for (pkg in packages) {
            tryCatch({
              if (!requireNamespace(pkg, quietly = TRUE)) {
                cat("Installing", pkg, "...\n")
                install.packages(pkg)
                cat("Successfully installed", pkg, "\n")
              } else {
                cat(pkg, "is already installed\n")
              }
            }, error = function(e) {
              cat("Error installing", pkg, ":", e$message, "\n")
              cat("Continuing with other packages\n")
            })
          }
          
          # Try to install TTR separately as it sometimes has issues
          tryCatch({
            if (!requireNamespace("TTR", quietly = TRUE)) {
              cat("Installing TTR...\n")
              install.packages("TTR")
              cat("Successfully installed TTR\n")
            } else {
              cat("TTR is already installed\n")
            }
          }, error = function(e) {
            cat("Error installing TTR:", e$message, "\n")
          })'
      
      - name: Set git config
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
      
      - name: Create .Rprofile for namespace handling
        run: |
          cat > .Rprofile << 'EOF'
          # Suppress startup messages
          options(tidyverse.quiet = TRUE)
          suppressMessages(library(dplyr))
          
          # Set explicit function preferences to avoid namespace conflicts
          assign("filter", dplyr::filter, envir = .GlobalEnv)
          assign("select", dplyr::select, envir = .GlobalEnv)
          assign("group_by", dplyr::group_by, envir = .GlobalEnv)
          assign("summarize", dplyr::summarize, envir = .GlobalEnv)
          assign("summarise", dplyr::summarise, envir = .GlobalEnv)
          assign("mutate", dplyr::mutate, envir = .GlobalEnv)
          assign("arrange", dplyr::arrange, envir = .GlobalEnv)
          
          # Set additional options
          options(
            width = 120,
            scipen = 999,
            max.print = 1000,
            warn = 1,
            # Increase download timeout
            timeout = 600,
            # Set repos with mirror that has binary packages
            repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/noble/latest")
          )
          EOF
      
      - name: Create fallback HTML template
        run: |
          # Create a simple HTML fallback in case Quarto fails
          cat > fallback.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Market Patterns Report</title>
            <style>
              body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
              h1 { color: #0A2540; }
              p { line-height: 1.6; }
              .message { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; }
            </style>
          </head>
          <body>
            <h1>Weekday Market Patterns Report</h1>
            <div class="message">
              <p>The automated report generation encountered issues. Please check the GitHub Actions workflow for details.</p>
              <p>This is a placeholder file until the report can be properly generated. Please try running the workflow again manually.</p>
            </div>
            <p>Generated on: $(date)</p>
          </body>
          </html>
          EOF
      
      - name: Verify directory structure
        run: |
          # Make sure any directories needed by the qmd exist
          mkdir -p figures
          mkdir -p data
          ls -la data/
      
      - name: Generate seed cache data if needed
        if: steps.market-data-cache.outputs.cache-hit != 'true'
        run: |
          echo "No cache found. Creating seed data for key indices..."
          cat > generate_seed_data.R << 'EOF'
          library(tidyverse)
          library(quantmod)
          library(lubridate)
          
          # Create necessary directories
          if (!dir.exists("data")) {
            dir.create("data", showWarnings = FALSE)
          }
          
          # Try to get data for S&P 500 (most reliable index)
          symbols <- c("^GSPC", "SPY", "SP500", "ES=F")
          sp500_data <- NULL
          
          for (symbol in symbols) {
            tryCatch({
              print(paste("Trying to fetch", symbol))
              ticker <- getSymbols(symbol, src = "yahoo", 
                                  from = Sys.Date() - years(5),
                                  to = Sys.Date(),
                                  auto.assign = FALSE)
              
              if (!is.null(ticker) && nrow(ticker) > 0) {
                print(paste("Successfully fetched", symbol))
                sp500_data <- data.frame(date = index(ticker), coredata(ticker))
                colnames(sp500_data) <- c("date", "open", "high", "low", "close", "volume", "adjusted")
                sp500_data$symbol <- symbol
                sp500_data$region <- "North America"
                sp500_data$index_name <- "ðŸ‡ºðŸ‡¸ S&P 500"
                sp500_data$canonical_index <- "S&P 500"
                break
              }
            }, error = function(e) {
              print(paste("Error fetching", symbol, ":", e$message))
            })
          }
          
          if (!is.null(sp500_data)) {
            print(paste("Successfully fetched basic data with", nrow(sp500_data), "rows"))
            
            # Save to cache files
            saveRDS(sp500_data, "data/global_market_data_cache_5yr.rds")
            saveRDS(sp500_data, paste0("data/global_market_data_cache_5yr_", format(Sys.Date(), "%Y_%m"), ".rds"))
            saveRDS(sp500_data, paste0("data/global_market_data_cache_5yr_", format(Sys.Date(), "%Y_%W"), ".rds"))
            saveRDS(sp500_data, paste0("data/global_market_data_cache_5yr_", format(Sys.Date(), "%Y_%m_%d"), ".rds"))
            
            print("Successfully saved seed data to cache files")
          } else {
            print("Failed to fetch seed data for cache")
          }
          EOF
          
          # Run the script
          Rscript generate_seed_data.R
      
      - name: Try Quarto render with retry mechanism
        run: |
          # Try rendering with multiple approaches and retries
          echo "Attempting to render with Quarto..."
          
          # Function to retry commands with increasing backoff
          retry_with_backoff() {
            local max_attempts="$1"; shift
            local cmd="$*"
            local attempt=1
            
            until $cmd; do
              if (( attempt == max_attempts )); then
                echo "Command failed after $max_attempts attempts: $cmd"
                return 1
              fi
              
              echo "Attempt $attempt failed! Retrying in $((attempt * 5)) seconds..."
              sleep $((attempt * 5))
              
              (( attempt++ ))
            done
            
            return 0
          }
          
          # Try full render first with retries
          if retry_with_backoff 3 quarto render weekday-market-patterns.qmd --to html; then
            echo "Full render succeeded"
          else
            echo "Full render failed, trying minimal render..."
            
            # Try minimal render with disabled caching
            if retry_with_backoff 2 quarto render weekday-market-patterns.qmd --to html --no-cache; then
              echo "Minimal render succeeded"
            else
              echo "Minimal render failed, trying direct R rendering..."
              
              # Try direct R rendering
              if retry_with_backoff 2 Rscript -e 'rmarkdown::render("weekday-market-patterns.qmd", output_format = "html_document")'; then
                echo "Direct R rendering succeeded"
              else
                echo "All rendering attempts failed"
              fi
            fi
          fi
      
      - name: Check for output and use fallback if needed
        run: |
          if [ -f weekday-market-patterns.html ]; then
            echo "Successfully generated HTML output"
          else
            echo "WARNING: Failed to generate report, using fallback template"
            cp fallback.html weekday-market-patterns.html
          fi
      
      - name: Create dated report copy
        run: cp weekday-market-patterns.html "market-patterns-report-$(date +'%Y-%m-%d').html"
      
      - name: Optimize HTML file
        run: |
          # Install html-minifier with error handling
          sudo npm install -g html-minifier || echo "Failed to install html-minifier, skipping optimization"
          
          # Try to optimize if minifier was installed
          if command -v html-minifier > /dev/null; then
            html-minifier --collapse-whitespace --remove-comments --remove-optional-tags \
              --remove-redundant-attributes --remove-script-type-attributes \
              --remove-tag-whitespace --use-short-doctype \
              weekday-market-patterns.html -o weekday-market-patterns.min.html || echo "Minification failed"
            
            if [ -f weekday-market-patterns.min.html ] && [ -s weekday-market-patterns.min.html ]; then
              mv weekday-market-patterns.min.html weekday-market-patterns.html
            fi
          else
            echo "Skipping HTML optimization"
          fi
      
      - name: Deploy report files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update market patterns report [automated] ${{ steps.get-date.outputs.date }}"
          file_pattern: "weekday-market-patterns.html market-patterns-report-*.html data/*.rds"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
          commit_author: GitHub Actions <actions@github.com>
          push_options: '--force'
          skip_dirty_check: true
